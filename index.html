<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>miniVK ‚Äî —Ñ—Ä–æ–Ω—Ç-only</title>
<style>
  :root{
    --bg:#0b0e13;
    --card:#121722;
    --muted:#94a3b8;
    --accent:#4f46e5;
    --accent-2:#22c55e;
    --danger:#ef4444;
    --text:#e5e7eb;
    --soft:#1b2230;
    --line:#233048;
  }
  *{box-sizing:border-box}
  html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Noto Sans",sans-serif}
  a{color:inherit;text-decoration:none}
  button{cursor:pointer}
  .container{max-width:900px;margin:0 auto;padding:16px}
  header{
    position:sticky;top:0;z-index:10;
    background:rgba(11,14,19,.9);backdrop-filter:saturate(140%) blur(10px);
    border-bottom:1px solid var(--line)
  }
  .nav{
    display:flex;align-items:center;gap:12px;justify-content:space-between;
    padding:10px 16px
  }
  .brand{display:flex;align-items:center;gap:10px}
  .logo{
    width:28px;height:28px;border-radius:8px;background:linear-gradient(135deg,var(--accent),#7c3aed);
    display:grid;place-items:center;font-weight:800
  }
  .nav-links{display:flex;gap:12px;flex-wrap:wrap}
  .nav-links a{
    padding:8px 10px;border-radius:10px;background:transparent;border:1px solid transparent;color:var(--muted)
  }
  .nav-links a.active{color:#fff;border-color:var(--line);background:var(--soft)}
  .auth{
    display:flex;align-items:center;gap:10px
  }
  .tiny-avatar{width:28px;height:28px;border-radius:50%;object-fit:cover;border:1px solid var(--line)}
  .btn,.btn-secondary,.btn-danger{
    padding:10px 14px;border-radius:12px;border:1px solid var(--line);background:var(--soft);color:#fff
  }
  .btn:hover{background:#20293c}
  .btn-secondary{background:#101625}
  .btn-danger{background:#1a0e12;border-color:#2c161c;color:#ffb4b4}
  .grid{display:grid;gap:12px}
  .card{
    background:var(--card);border:1px solid var(--line);border-radius:16px;padding:14px
  }
  .card-header{display:flex;gap:12px;align-items:center}
  .avatar{width:40px;height:40px;border-radius:50%;object-fit:cover;border:1px solid var(--line);background:#0f172a}
  .post-head{display:flex;justify-content:space-between;align-items:flex-start;gap:8px}
  .muted{color:var(--muted);font-size:12px}
  .post-text{white-space:pre-wrap;line-height:1.4;margin-top:6px}
  .actions{display:flex;gap:8px;align-items:center;margin-top:8px;flex-wrap:wrap}
  .pill{
    display:inline-flex;align-items:center;gap:6px;
    padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:var(--soft);font-size:14px
  }
  .pill[disabled]{opacity:.6;cursor:not-allowed}
  .comment-toggle{cursor:pointer}
  .comments{margin-top:10px;border-top:1px dashed var(--line);padding-top:10px}
  .comment{display:flex;gap:10px;margin-top:10px}
  .comment .avatar{width:28px;height:28px}
  .field{display:flex;flex-direction:column;gap:6px}
  .input,.textarea{
    width:100%;background:#0c121e;border:1px solid var(--line);color:#fff;border-radius:12px;padding:10px 12px
  }
  .textarea{min-height:80px;resize:vertical}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  .hint{font-size:12px;color:var(--muted)}
  .error{font-size:12px;color:#ff9c9c}
  .profile{
    display:grid;gap:16px;grid-template-columns:120px 1fr
  }
  .big-avatar{width:120px;height:120px;border-radius:50%;object-fit:cover;border:1px solid var(--line)}
  .sub-list a{display:inline-flex;gap:8px;align-items:center;padding:8px 10px;background:var(--soft);border:1px solid var(--line);border-radius:12px}
  .users-list{display:grid;gap:10px}
  .user-row{display:flex;align-items:center;gap:10px;justify-content:space-between;background:var(--card);border:1px solid var(--line);border-radius:12px;padding:10px}
  .user-row .left{display:flex;align-items:center;gap:10px}
  .search{display:flex;gap:8px}
  footer{opacity:.6;text-align:center;margin:24px 0}
  @media (max-width:600px){
    .profile{grid-template-columns:1fr}
    .nav{gap:8px}
    .nav-links{gap:6px}
    .nav-links a{padding:8px 8px}
  }
</style>
</head>
<body>
<header>
  <div class="nav container">
    <div class="brand">
      <div class="logo">–°–ö</div>
      <strong>–°–≤–æ–π–ö—Ä—É–≥</strong>
    </div>
    <nav class="nav-links" id="nav-links">
      <a href="#/feed" data-route="feed">–õ–µ–Ω—Ç–∞</a>
      <a href="#/users" data-route="users">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</a>
      <a href="#/profile" data-route="profile">–ü—Ä–æ—Ñ–∏–ª—å</a>
      <a href="#/auth" data-route="auth">–í—Ö–æ–¥/–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</a>
    </nav>
    <div class="auth" id="auth-area">
      <!-- –¥–∏–Ω–∞–º–∏–∫–∞: –∞–≤–∞—Ç–∞—Ä/–ª–æ–≥–∏–Ω + –≤—ã—Ö–æ–¥ –∏–ª–∏ –∫–Ω–æ–ø–∫–∞ –≤—Ö–æ–¥–∞ -->
    </div>
  </div>
</header>

<main class="container">
  <div id="app" class="grid"></div>
</main>

<footer class="container">
  <div class="hint">–§—Ä–æ–Ω—Ç–µ–Ω–¥ —Ç–æ–ª—å–∫–æ –Ω–∞ HTML/CSS/JS. –î–∞–Ω–Ω—ã–µ ‚Äî –≤ localStorage.</div>
</footer>

<script>
/* ================================ UTILS ==================================== */
const Utils = (() => {
  const te = new TextEncoder();

  function sanitize(str){
    return String(str)
      .replaceAll('&','&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;');
  }
  function textToHtml(text){
    return sanitize(text).replace(/\n/g,'<br>');
  }
  function pad(n){return n<10?'0'+n:n}
  function formatDate(iso){
    const d = new Date(iso);
    const now = new Date();
    const dd = pad(d.getDate()), mm = pad(d.getMonth()+1), yyyy = d.getFullYear();
    const hh = pad(d.getHours()), mi = pad(d.getMinutes());
    const dayMs = 24*60*60*1000;
    const startToday = new Date(now.getFullYear(),now.getMonth(),now.getDate()).getTime();
    const startGiven = new Date(d.getFullYear(),d.getMonth(),d.getDate()).getTime();
    const diffDays = Math.round((startGiven - startToday)/dayMs);
    if(diffDays === 0) return `—Å–µ–≥–æ–¥–Ω—è, ${hh}:${mi}`;
    if(diffDays === -1) return `–≤—á–µ—Ä–∞, ${hh}:${mi}`;
    return `${dd}.${mm}.${yyyy}, ${hh}:${mi}`;
  }
  function toHex(buffer){
    const arr = new Uint8Array(buffer);
    return Array.from(arr).map(b=>b.toString(16).padStart(2,'0')).join('');
  }
  async function sha256(str){
    const digest = await crypto.subtle.digest('SHA-256', te.encode(str));
    return toHex(digest);
  }
  function genId(prefix='id'){
    const rnd = new Uint32Array(4);
    crypto.getRandomValues(rnd);
    return `${prefix}-${Date.now()}-${Array.from(rnd).map(x=>x.toString(16)).join('')}`;
  }
  function ensureAuthTooltip(el, isAuthed){
    if(!isAuthed){
      el.setAttribute('disabled','disabled');
      el.title = '–î–æ—Å—Ç—É–ø–Ω–æ –ø–æ—Å–ª–µ –≤—Ö–æ–¥–∞';
      el.classList.add('disabled');
    }
  }
  function fileToImage(file){
    return new Promise((resolve,reject)=>{
      const fr = new FileReader();
      fr.onload = () => {
        const img = new Image();
        img.onload = ()=>resolve(img);
        img.onerror = reject;
        img.src = fr.result;
      };
      fr.onerror = reject;
      fr.readAsDataURL(file);
    });
  }
  async function compressToDataURL(file, max=256){
    const img = await fileToImage(file);
    const scale = Math.min(1, max/Math.max(img.width,img.height));
    const w = Math.max(1, Math.round(img.width*scale));
    const h = Math.max(1, Math.round(img.height*scale));
    const canvas = document.createElement('canvas');
    canvas.width = w; canvas.height = h;
    const ctx = canvas.getContext('2d');
    ctx.imageSmoothingQuality = 'high';
    ctx.drawImage(img,0,0,w,h);
    return canvas.toDataURL('image/png', 0.92);
  }
  function initialAvatar(username){
    // –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∞–≤—É –ø–æ –∏–Ω–∏—Ü–∏–∞–ª–∞–º –Ω–∞ –∫–∞–Ω–≤–∞—Å–µ
    const seed = Array.from(username).reduce((a,c)=>a+c.charCodeAt(0),0);
    const colors = ['#22c55e','#06b6d4','#f59e0b','#ef4444','#8b5cf6','#10b981','#3b82f6'];
    const bg = colors[seed % colors.length];
    const canvas = document.createElement('canvas');
    canvas.width=256; canvas.height=256;
    const ctx = canvas.getContext('2d');
    ctx.fillStyle = bg; ctx.fillRect(0,0,256,256);
    ctx.fillStyle = '#0b0e13';
    ctx.beginPath(); ctx.arc(128,128,120,0,Math.PI*2); ctx.fill();
    ctx.fillStyle = '#fff';
    ctx.font = 'bold 120px system-ui, sans-serif';
    ctx.textAlign='center'; ctx.textBaseline='middle';
    const letters = username.slice(0,2).toUpperCase();
    ctx.fillText(letters,128,140);
    return canvas.toDataURL('image/png');
  }
  return {sanitize,textToHtml,formatDate,sha256,genId,ensureAuthTooltip,compressToDataURL,initialAvatar};
})();

/* ================================ DATA ===================================== */
class DB {
  constructor(){
    // lazy loaded
    this._users = null;
    this._posts = null;
    this._comments = null;
    this._session = null;
  }
  _load(){
    this._users = JSON.parse(localStorage.getItem('users') || '[]');
    this._posts = JSON.parse(localStorage.getItem('posts') || '[]');
    this._comments = JSON.parse(localStorage.getItem('comments') || '[]');
    this._session = JSON.parse(localStorage.getItem('session') || 'null');
  }
  _save(){
    localStorage.setItem('users', JSON.stringify(this._users));
    localStorage.setItem('posts', JSON.stringify(this._posts));
    localStorage.setItem('comments', JSON.stringify(this._comments));
    localStorage.setItem('session', JSON.stringify(this._session));
  }
  get users(){ if(this._users===null) this._load(); return this._users }
  get posts(){ if(this._posts===null) this._load(); return this._posts }
  get comments(){ if(this._comments===null) this._load(); return this._comments }
  get session(){ if(this._session===null) this._load(); return this._session }
  set session(v){ this._session = v; this._save(); }

  getCurrentUser(){
    if(!this.session) return null;
    return this.users.find(u=>u.id===this.session.userId) || null;
  }
  findUserByLogin(username){
    const uname = username.toLowerCase();
    return this.users.find(u=>u.username.toLowerCase()===uname) || null;
  }
  getUserById(id){
    return this.users.find(u=>u.id===id) || null;
  }
  getPostsByUser(userId){
    return this.posts.filter(p=>p.authorId===userId).sort((a,b)=>b.createdAtISO.localeCompare(a.createdAtISO));
  }
  getCommentsByPost(postId){
    return this.comments.filter(c=>c.postId===postId).sort((a,b)=>a.createdAtISO.localeCompare(b.createdAtISO));
  }

  async addUser({username,password,avatarFile}){
    // validation
    if(!/^[a-zA-Z0-9_]{3,20}$/.test(username)) throw new Error('–õ–æ–≥–∏–Ω: –ª–∞—Ç–∏–Ω–∏—Ü–∞/—Ü–∏—Ñ—Ä—ã/_; 3‚Äì20 —Å–∏–º–≤–æ–ª–æ–≤.');
    if(this.findUserByLogin(username)) throw new Error('–õ–æ–≥–∏–Ω —É–∂–µ –∑–∞–Ω—è—Ç.');
    if(!password || password.length<6) throw new Error('–ü–∞—Ä–æ–ª—å: –º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤.');
    const passHash = await Utils.sha256(password);
    let avatarDataUrl = null;
    if(avatarFile){
      try{ avatarDataUrl = await Utils.compressToDataURL(avatarFile,256) }catch(e){ /* ignore */ }
    }else{
      avatarDataUrl = Utils.initialAvatar(username);
    }
    const user = {
      id: Utils.genId('usr'),
      username,
      passHash,
      createdAtISO: new Date().toISOString(),
      avatarDataUrl,
      subscriptions:[]
    };
    this.users.push(user);
    this._save();
    return user;
  }

  async auth({username,password}){
    const user = this.findUserByLogin(username);
    if(!user) throw new Error('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω.');
    const passHash = await Utils.sha256(password);
    if(passHash !== user.passHash) throw new Error('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å.');
    this.session = {userId:user.id};
    return user;
  }
  logout(){ this.session = null }

  createPost({text}){
    text = (text||'').trim();
    if(!text) throw new Error('–¢–µ–∫—Å—Ç –ø–æ—Å—Ç–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º.');
    const user = this.getCurrentUser();
    if(!user) throw new Error('–¢—Ä–µ–±—É–µ—Ç—Å—è –≤—Ö–æ–¥.');
    const post = {
      id: Utils.genId('pst'),
      authorId: user.id,
      text,
      createdAtISO: new Date().toISOString(),
      likes:[]
    };
    this.posts.push(post);
    this._save();
    return post;
  }

  toggleLike(postId){
    const me = this.getCurrentUser();
    if(!me) throw new Error('–¢—Ä–µ–±—É–µ—Ç—Å—è –≤—Ö–æ–¥.');
    const post = this.posts.find(p=>p.id===postId);
    if(!post) throw new Error('–ü–æ—Å—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω.');
    const idx = post.likes.indexOf(me.id);
    if(idx===-1) post.likes.push(me.id);
    else post.likes.splice(idx,1);
    this._save();
    return post.likes.length;
  }

  addComment({postId,text}){
    text = (text||'').trim();
    if(!text) throw new Error('–ü—É—Å—Ç–æ–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π.');
    const me = this.getCurrentUser();
    if(!me) throw new Error('–¢—Ä–µ–±—É–µ—Ç—Å—è –≤—Ö–æ–¥.');
    const post = this.posts.find(p=>p.id===postId);
    if(!post) throw new Error('–ü–æ—Å—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω.');
    const comment = {
      id: Utils.genId('cmt'),
      postId,
      authorId: me.id,
      text,
      createdAtISO: new Date().toISOString()
    };
    this.comments.push(comment);
    this._save();
    return comment;
  }

  toggleSubscribe(targetUserId){
    const me = this.getCurrentUser();
    if(!me) throw new Error('–¢—Ä–µ–±—É–µ—Ç—Å—è –≤—Ö–æ–¥.');
    if(me.id === targetUserId) throw new Error('–ù–µ–ª—å–∑—è –ø–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ —Å–µ–±—è.');
    const idx = me.subscriptions.indexOf(targetUserId);
    if(idx===-1) me.subscriptions.push(targetUserId);
    else me.subscriptions.splice(idx,1);
    this._save();
    return me.subscriptions.slice();
  }

  async updateAvatar(file){
    const me = this.getCurrentUser();
    if(!me) throw new Error('–¢—Ä–µ–±—É–µ—Ç—Å—è –≤—Ö–æ–¥.');
    const dataUrl = await Utils.compressToDataURL(file,256);
    me.avatarDataUrl = dataUrl;
    this._save();
    return dataUrl;
  }

  /* ---------- Seed demo data on first run ---------- */
  async ensureSeed(){
    this._load();
    const firstRun = this.users.length===0 && this.posts.length===0 && this.comments.length===0 && this.session===null;
    if(!firstRun) return;
    const u1 = await this.addUser({username:'ivan', password:'123456'});
    const u2 = await this.addUser({username:'maxim', password:'123456'});
    const u3 = await this.addUser({username:'guest_01', password:'123456'});
    // Posts
    const now = Date.now();
    const p1 = {
      id: Utils.genId('pst'),
      authorId: u1.id,
      text: '–ü—Ä–∏–≤–µ—Ç! –≠—Ç–æ –¥–µ–º–æ-–ø–æ—Å—Ç –≤ miniVK üëã',
      createdAtISO: new Date(now-3600_000).toISOString(),
      likes:[u2.id]
    };
    const p2 = {
      id: Utils.genId('pst'),
      authorId: u2.id,
      text: '–°–µ–≥–æ–¥–Ω—è —Ç–µ—Å—Ç–∏—Ä—É–µ–º –ª–∞–π–∫–∏, –∫–æ–º–º–µ–Ω—Ç—ã –∏ –ø–æ–¥–ø–∏—Å–∫–∏.',
      createdAtISO: new Date(now-1800_000).toISOString(),
      likes:[u1.id,u3.id]
    };
    this.posts.push(p1,p2);
    // Comments
    this.comments.push({
      id: Utils.genId('cmt'),
      postId:p2.id, authorId:u1.id,
      text:'–†–∞–±–æ—Ç–∞–µ—Ç! üëç', createdAtISO:new Date(now-1200_000).toISOString()
    });
    this._save();
  }
}
const db = new DB();

/* ================================ STATE ==================================== */
const State = {
  route: {name:'feed', params:{}},
  expandComments: new Set(), // postId that expanded
};

/* ================================ VIEWS ==================================== */
const Views = (() => {

  function renderHeader(){
    const links = document.querySelectorAll('#nav-links a');
    links.forEach(a=>{
      a.classList.remove('active');
      const r=a.dataset.route;
      if(State.route.name==='profile' && r==='profile') a.classList.add('active');
      else if(State.route.name===r) a.classList.add('active');
    });
    const authArea = document.getElementById('auth-area');
    const me = db.getCurrentUser();
    if(me){
      authArea.innerHTML = `
        <img class="tiny-avatar" src="${me.avatarDataUrl || Utils.initialAvatar(me.username)}" alt="">
        <span class="muted">@${Utils.sanitize(me.username)}</span>
        <button class="btn-secondary" id="btn-logout" title="–í—ã–π—Ç–∏">–í—ã–π—Ç–∏</button>
      `;
      document.getElementById('btn-logout').onclick = ()=>{
        db.logout();
        location.hash = '#/auth';
        Router.rerender();
      };
    }else{
      authArea.innerHTML = `<a class="btn" href="#/auth">–í–æ–π—Ç–∏</a>`;
    }
  }

  function postCard(post, {showCommentsToggle=true}={}){
    const author = db.getUserById(post.authorId) || {username:'unknown',avatarDataUrl:null,createdAtISO:new Date().toISOString()};
    const me = db.getCurrentUser();
    const liked = me ? post.likes.includes(me.id) : false;
    const wrap = document.createElement('div');
    wrap.className='card';
    const commentsCount = db.getCommentsByPost(post.id).length;

    wrap.innerHTML = `
      <div class="post-head">
        <div class="card-header">
          <img class="avatar" src="${author.avatarDataUrl || Utils.initialAvatar(author.username)}" alt="">
          <div>
            <div><a href="#/profile/${author.id}"><strong>@${Utils.sanitize(author.username)}</strong></a></div>
            <div class="muted">${Utils.formatDate(post.createdAtISO)}</div>
          </div>
        </div>
      </div>
      <div class="post-text">${Utils.textToHtml(post.text)}</div>
      <div class="actions">
        <button class="pill like-btn" data-id="${post.id}" aria-pressed="${liked}">${liked?'‚ù§Ô∏è':'ü§ç'} <span>${post.likes.length}</span></button>
        ${showCommentsToggle ? `<span class="pill comment-toggle" data-id="${post.id}">üí¨ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ (${commentsCount})</span>` : ''}
        <a class="pill" href="#/profile/${author.id}">–ü—Ä–æ—Ñ–∏–ª—å –∞–≤—Ç–æ—Ä–∞</a>
      </div>
      <div class="comments" id="comments-${post.id}" style="display:${State.expandComments.has(post.id)?'block':'none'}"></div>
    `;
    // like guard
    const likeBtn = wrap.querySelector('.like-btn');
    Utils.ensureAuthTooltip(likeBtn, !!me);
    likeBtn.onclick = ()=>{
      if(!me) return;
      try{
        const count = db.toggleLike(post.id);
        likeBtn.setAttribute('aria-pressed', likeBtn.getAttribute('aria-pressed')==='true'?'false':'true');
        likeBtn.innerHTML = `${post.likes.includes(me.id)?'‚ù§Ô∏è':'ü§ç'} <span>${count}</span>`;
      }catch(e){ alert(e.message) }
    };

    // comments toggle
    if(showCommentsToggle){
      wrap.querySelector('.comment-toggle').onclick = ()=>{
        const opened = State.expandComments.has(post.id);
        if(opened){ State.expandComments.delete(post.id) } else { State.expandComments.add(post.id) }
        renderComments(post.id);
      };
      if(State.expandComments.has(post.id)) renderComments(post.id);
    }
    return wrap;
  }

  function renderComments(postId){
    const container = document.getElementById(`comments-${postId}`);
    if(!container) return;
    const me = db.getCurrentUser();
    if(!State.expandComments.has(postId)){
      container.style.display='none';
      container.innerHTML='';
      return;
    }
    container.style.display='block';
    const list = db.getCommentsByPost(postId);
    container.innerHTML = list.map(c=>{
      const u = db.getUserById(c.authorId) || {username:'unknown',avatarDataUrl:null};
      return `
        <div class="comment">
          <img class="avatar" src="${u.avatarDataUrl || Utils.initialAvatar(u.username)}" alt="">
          <div>
            <div><a href="#/profile/${u.id}"><strong>@${Utils.sanitize(u.username)}</strong></a> <span class="muted">¬∑ ${Utils.formatDate(c.createdAtISO)}</span></div>
            <div class="post-text">${Utils.textToHtml(c.text)}</div>
          </div>
        </div>
      `;
    }).join('') + `
      <div class="row" style="margin-top:10px;">
        <textarea class="textarea" id="cmt-text-${postId}" placeholder="${me?'–ù–∞–ø–∏—Å–∞—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π‚Ä¶':'–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å'}"></textarea>
        <button class="btn" id="cmt-send-${postId}">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      </div>
      <div class="hint">–£–≤–∞–∂–∞–π—Ç–µ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–æ–≤ üòä</div>
    `;
    const btn = container.querySelector(`#cmt-send-${postId}`);
    Utils.ensureAuthTooltip(btn, !!me);
    btn.onclick = ()=>{
      if(!me) return;
      const ta = container.querySelector(`#cmt-text-${postId}`);
      try{
        db.addComment({postId, text: ta.value});
        ta.value='';
        renderComments(postId);
      }catch(e){ alert(e.message) }
    };
  }

  function Feed(){
    const root = document.createElement('div');
    root.className='grid';

    const me = db.getCurrentUser();
    // composer
    const composer = document.createElement('div');
    composer.className='card';
    composer.innerHTML = `
      <div class="field">
        <label><strong>–ù–æ–≤—ã–π –ø–æ—Å—Ç</strong></label>
        <textarea class="textarea" id="post-text" placeholder="${me?'–ü–æ–¥–µ–ª–∏—Ç–µ—Å—å –Ω–æ–≤–æ—Å—Ç—è–º–∏‚Ä¶':'–í–æ–π–¥–∏—Ç–µ/–∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å, —á—Ç–æ–±—ã –ø–∏—Å–∞—Ç—å'}"></textarea>
        <div class="row">
          <button class="btn" id="post-send">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
          <div class="hint">–ü–æ—Å—Ç—ã –ø–æ—è–≤–ª—è—é—Ç—Å—è —Å–≤–µ—Ä—Ö—É. –¢–µ–∫—Å—Ç –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω.</div>
        </div>
      </div>
    `;
    const sendBtn = composer.querySelector('#post-send');
    Utils.ensureAuthTooltip(sendBtn, !!me);
    sendBtn.onclick = ()=>{
      if(!me) return;
      const txt = composer.querySelector('#post-text').value;
      try{
        db.createPost({text:txt});
        composer.querySelector('#post-text').value='';
        Router.rerender();
      }catch(e){ alert(e.message) }
    };
    root.appendChild(composer);

    // feed list
    const posts = db.posts.slice().sort((a,b)=>b.createdAtISO.localeCompare(a.createdAtISO));
    if(posts.length===0){
      const empty = document.createElement('div');
      empty.className='card';
      empty.innerHTML = `<div class="muted">–ü–æ–∫–∞ –ø—É—Å—Ç–æ. –ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º ‚Äî –æ–ø—É–±–ª–∏–∫—É–π—Ç–µ –ø–æ—Å—Ç!</div>`;
      root.appendChild(empty);
    }else{
      posts.forEach(p=>root.appendChild(postCard(p)));
    }
    return root;
  }

  function Profile(userId){
    const me = db.getCurrentUser();
    const u = userId ? db.getUserById(userId) : (me || null);
    if(!u){
      const wrap = document.createElement('div');
      wrap.className='card';
      wrap.innerHTML = `<div class="muted">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω. <a href="#/users">–ö —Å–ø–∏—Å–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</a></div>`;
      return wrap;
    }
    const myProfile = me && me.id===u.id;

    const wrap = document.createElement('div');
    wrap.className='grid';

    const top = document.createElement('div');
    top.className='card profile';
    top.innerHTML = `
      <div>
        <img class="big-avatar" id="big-avatar" src="${u.avatarDataUrl || Utils.initialAvatar(u.username)}" alt="">
      </div>
      <div class="grid">
        <div>
          <h2 style="margin:0;">@${Utils.sanitize(u.username)}</h2>
          <div class="muted">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω: ${Utils.formatDate(u.createdAtISO)}</div>
        </div>
        <div class="row">
          <span class="pill">–ü–æ—Å—Ç–æ–≤: ${db.getPostsByUser(u.id).length}</span>
          <span class="pill">–ü–æ–¥–ø–∏—Å–æ–∫: ${u.subscriptions.length}</span>
        </div>
        <div class="row">
          ${myProfile ? `
            <label class="btn">
              <input type="file" id="avatar-input" accept="image/*" style="display:none">
              –ò–∑–º–µ–Ω–∏—Ç—å –∞–≤–∞—Ç–∞—Ä
            </label>
          ` : `
            <button class="btn" id="btn-sub"></button>
          `}
          <a class="btn-secondary" href="#/feed">–í –ª–µ–Ω—Ç—É</a>
        </div>
      </div>
    `;
    wrap.appendChild(top);

    // subscriptions (only my profile)
    if(myProfile){
      const subs = u.subscriptions.map(id=>db.getUserById(id)).filter(Boolean);
      const subsCard = document.createElement('div');
      subsCard.className='card';
      subsCard.innerHTML = `<div><strong>–ú–æ–∏ –ø–æ–¥–ø–∏—Å–∫–∏</strong></div>
        <div class="row sub-list" style="margin-top:8px;">
          ${subs.length?subs.map(s=>`
            <a href="#/profile/${s.id}">
              <img class="avatar" style="width:24px;height:24px" src="${s.avatarDataUrl || Utils.initialAvatar(s.username)}">
              <span>@${Utils.sanitize(s.username)}</span>
            </a>
          `).join(''):`<div class="muted">–ù–∏ –Ω–∞ –∫–æ–≥–æ –Ω–µ –ø–æ–¥–ø–∏—Å–∞–Ω.</div>`}
        </div>`;
      wrap.appendChild(subsCard);
    }

    // posts
    const myPosts = db.getPostsByUser(u.id);
    const postsCard = document.createElement('div');
    postsCard.className='grid';
    if(myPosts.length===0){
      const empty = document.createElement('div');
      empty.className='card';
      empty.innerHTML = `<div class="muted">–ü–æ—Å—Ç–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç.</div>`;
      postsCard.appendChild(empty);
    }else{
      myPosts.forEach(p=>postsCard.appendChild(postCard(p)));
    }
    wrap.appendChild(postsCard);

    // actions wiring
    if(myProfile){
      const fileInput = top.querySelector('#avatar-input');
      const labelBtn = top.querySelector('label.btn');
      Utils.ensureAuthTooltip(labelBtn, !!me);
      labelBtn.onclick = ()=> fileInput.click();
      fileInput.onchange = async (e)=>{
        const file = e.target.files?.[0];
        if(!file) return;
        try{
          const url = await db.updateAvatar(file);
          top.querySelector('#big-avatar').src = url;
          document.querySelector('.tiny-avatar').src = url;
        }catch(err){ alert(err.message) }
      };
    }else{
      const btnSub = top.querySelector('#btn-sub');
      const isSubbed = me ? me.subscriptions.includes(u.id) : false;
      btnSub.textContent = isSubbed ? '–û—Ç–ø–∏—Å–∞—Ç—å—Å—è' : '–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è';
      Utils.ensureAuthTooltip(btnSub, !!me);
      btnSub.onclick = ()=>{
        if(!me) return;
        try{
          db.toggleSubscribe(u.id);
          Router.rerender();
        }catch(e){ alert(e.message) }
      };
    }
    return wrap;
  }

  function Users(){
    const wrap = document.createElement('div');
    wrap.className='grid';

    const card = document.createElement('div');
    card.className='card';
    card.innerHTML = `
      <div class="search">
        <input class="input" id="q" placeholder="–ü–æ–∏—Å–∫ –ø–æ –ª–æ–≥–∏–Ω—É‚Ä¶">
        <button class="btn" id="go">–ù–∞–π—Ç–∏</button>
      </div>
    `;
    wrap.appendChild(card);

    const list = document.createElement('div');
    list.className='users-list';
    wrap.appendChild(list);

    function renderList(){
      const q = (card.querySelector('#q').value||'').trim().toLowerCase();
      const arr = db.users
        .slice()
        .sort((a,b)=>a.username.localeCompare(b.username))
        .filter(u=>u.username.toLowerCase().includes(q));
      list.innerHTML = arr.map(u=>`
        <div class="user-row">
          <div class="left">
            <img class="avatar" src="${u.avatarDataUrl || Utils.initialAvatar(u.username)}" alt="">
            <div>
              <div><a href="#/profile/${u.id}"><strong>@${Utils.sanitize(u.username)}</strong></a></div>
              <div class="muted">–° ${Utils.formatDate(u.createdAtISO)}</div>
            </div>
          </div>
          <div class="row">
            <a class="btn-secondary" href="#/profile/${u.id}">–ü–µ—Ä–µ–π—Ç–∏</a>
          </div>
        </div>
      `).join('') || `<div class="card"><div class="muted">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.</div></div>`;
    }
    renderList();
    card.querySelector('#go').onclick = renderList;
    card.querySelector('#q').onkeydown = (e)=>{ if(e.key==='Enter') renderList() };

    return wrap;
  }

  function Auth(){
    const me = db.getCurrentUser();
    const wrap = document.createElement('div');
    wrap.className='grid';

    const card = document.createElement('div');
    card.className='card';
    if(me){
      card.innerHTML = `<div class="grid">
        <div><strong>–í—ã —É–∂–µ –≤–æ—à–ª–∏ –∫–∞–∫ @${Utils.sanitize(me.username)}</strong></div>
        <div class="row">
          <a class="btn" href="#/feed">–í –ª–µ–Ω—Ç—É</a>
          <a class="btn-secondary" href="#/profile">–í –ø—Ä–æ—Ñ–∏–ª—å</a>
          <button class="btn-danger" id="logout">–í—ã–π—Ç–∏</button>
        </div>
      </div>`;
      wrap.appendChild(card);
      card.querySelector('#logout').onclick = ()=>{ db.logout(); Router.rerender() };
      return wrap;
    }

    card.innerHTML = `
      <div class="grid" style="gap:16px">
        <div class="row">
          <button class="btn" id="tab-login">–í—Ö–æ–¥</button>
          <button class="btn-secondary" id="tab-reg">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
        </div>
        <div id="pane"></div>
      </div>
    `;
    wrap.appendChild(card);

    const pane = card.querySelector('#pane');
    function showLogin(){
      card.querySelector('#tab-login').className='btn';
      card.querySelector('#tab-reg').className='btn-secondary';
      pane.innerHTML = `
        <div class="grid">
          <div class="field">
            <label>–õ–æ–≥–∏–Ω</label>
            <input class="input" id="login-username" placeholder="your_name">
            <div class="hint">–õ–∞—Ç–∏–Ω–∏—Ü–∞/—Ü–∏—Ñ—Ä—ã/_ (3‚Äì20)</div>
            <div class="error" id="login-err-user"></div>
          </div>
          <div class="field">
            <label>–ü–∞—Ä–æ–ª—å</label>
            <input class="input" id="login-pass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
            <div class="error" id="login-err-pass"></div>
          </div>
          <div class="row">
            <button class="btn" id="login-btn">–í–æ–π—Ç–∏</button>
            <a class="btn-secondary" href="#/feed">–í –ª–µ–Ω—Ç—É</a>
          </div>
        </div>
      `;
      pane.querySelector('#login-btn').onclick = async ()=>{
        const u = pane.querySelector('#login-username').value.trim();
        const p = pane.querySelector('#login-pass').value;
        pane.querySelector('#login-err-user').textContent='';
        pane.querySelector('#login-err-pass').textContent='';
        try{
          await db.auth({username:u,password:p});
          location.hash = '#/feed';
          Router.rerender();
        }catch(e){
          if(e.message.includes('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å')) pane.querySelector('#login-err-user').textContent = e.message;
          else pane.querySelector('#login-err-pass').textContent = e.message;
        }
      };
    }
    async function showReg(){
      card.querySelector('#tab-login').className='btn-secondary';
      card.querySelector('#tab-reg').className='btn';
      pane.innerHTML = `
        <div class="grid">
          <div class="field">
            <label>–õ–æ–≥–∏–Ω</label>
            <input class="input" id="reg-username" placeholder="your_name">
            <div class="hint">–õ–∞—Ç–∏–Ω–∏—Ü–∞/—Ü–∏—Ñ—Ä—ã/_ (3‚Äì20). –£–Ω–∏–∫–∞–ª—å–Ω—ã–π.</div>
            <div class="error" id="reg-err-user"></div>
          </div>
          <div class="field">
            <label>–ü–∞—Ä–æ–ª—å</label>
            <input class="input" id="reg-pass" type="password" placeholder="–º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤">
            <div class="error" id="reg-err-pass"></div>
          </div>
          <div class="field">
            <label>–ê–≤–∞—Ç–∞—Ä (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
            <input class="input" id="reg-ava" type="file" accept="image/*">
            <div class="hint">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –±—É–¥–µ—Ç —Å–∂–∞—Ç–æ –¥–æ 256√ó256.</div>
          </div>
          <div class="row">
            <button class="btn" id="reg-btn">–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
            <a class="btn-secondary" href="#/feed">–í –ª–µ–Ω—Ç—É</a>
          </div>
        </div>
      `;
      pane.querySelector('#reg-btn').onclick = async ()=>{
        const username = pane.querySelector('#reg-username').value.trim();
        const password = pane.querySelector('#reg-pass').value;
        const file = pane.querySelector('#reg-ava').files?.[0]||null;
        pane.querySelector('#reg-err-user').textContent='';
        pane.querySelector('#reg-err-pass').textContent='';
        try{
          await db.addUser({username,password,avatarFile:file});
          await db.auth({username,password});
          location.hash = '#/feed';
          Router.rerender();
        }catch(e){
          if(e.message.includes('–õ–æ–≥–∏–Ω')) pane.querySelector('#reg-err-user').textContent = e.message;
          else pane.querySelector('#reg-err-pass').textContent = e.message;
        }
      };
    }
    card.querySelector('#tab-login').onclick = showLogin;
    card.querySelector('#tab-reg').onclick = showReg;
    showLogin();
    return wrap;
  }

  return {renderHeader, Feed, Profile, Users, Auth, postCard};
})();

/* ================================ ROUTER =================================== */
const Router = (() => {
  function parse(){
    let hash = location.hash || '#/feed';
    if(!hash.startsWith('#/')) hash = '#/feed';
    const parts = hash.slice(2).split('/'); // [feed] or [profile, id]
    let name = parts[0] || 'feed';
    let params = {};
    if(name==='profile'){
      if(parts[1]) params.id = parts[1];
      else {
        const me = db.getCurrentUser();
        if(me) params.id = me.id;
        else name = 'auth';
      }
    }
    if(!['feed','profile','users','auth'].includes(name)) name='feed';
    return {name, params};
  }

  function render(){
    State.route = parse();
    Views.renderHeader();

    const app = document.getElementById('app');
    app.innerHTML = ''; // clear

    switch(State.route.name){
      case 'feed': app.appendChild(Views.Feed()); break;
      case 'users': app.appendChild(Views.Users()); break;
      case 'profile': app.appendChild(Views.Profile(State.route.params.id)); break;
      case 'auth': app.appendChild(Views.Auth()); break;
    }
  }

  function rerender(){ render() }

  window.addEventListener('hashchange', render);

  return {render, rerender};
})();

/* =============================== BOOTSTRAP ================================= */
(async function main(){
  await db.ensureSeed();
  if(!location.hash) location.hash = '#/feed';
  Router.render();
})();
</script>
</body>
</html>
